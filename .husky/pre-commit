#!/bin/sh

echo "ğŸ” Verificando por chaves sensÃ­veis..."

FILES=$(git diff --cached --name-only --diff-filter=ACM)
abort=false

for file in $FILES; do
    # Ignora o prÃ³prio hook
    if [ "$file" = ".husky/pre-commit" ]; then
        continue
    fi

    if grep -q -E -- "-----BEGIN PRIVATE KEY-----" "$file"; then
        echo "ğŸš« Chave privada detectada em $file"
        abort=true
    fi

    if grep -q -E -- "AKIA[0-9A-Z]{16}" "$file"; then
        echo "ğŸš« AWS Key detectada em $file"
        abort=true
    fi

    if grep -q -E -- "AIza[0-9A-Za-z\-_]{35}" "$file"; then
        echo "ğŸš« Google API Key detectada em $file"
        abort=true
    fi

    if grep -q -E -- "ssh-rsa AAAA[0-9A-Za-z+/]+[=]{0,3}" "$file"; then
        echo "ğŸš« SSH Key detectada em $file"
        abort=true
    fi

    if grep -q -E -- "ghp_[A-Za-z0-9]{36}" "$file"; then
        echo "ğŸš« GitHub Token detectado em $file"
        abort=true
    fi

    if grep -q -E -- "eyJ[a-zA-Z0-9\-_]+\.[a-zA-Z0-9\-_]+\.[a-zA-Z0-9\-_]+" "$file"; then
        echo "ğŸš« JWT Token detectado em $file"
        abort=true
    fi
done

if [ "$abort" = true ]; then
    echo "âŒ Commit cancelado. Remova as chaves privadas antes de commitar."
    exit 1
fi

echo "âœ… Nenhuma chave sensÃ­vel encontrada. Continuando o commit..."